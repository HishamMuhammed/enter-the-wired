#!/bin/bash
set -euo pipefail

# ENTER THE WIRED
# "I am here. But where is here? And where is here within here?"

# Combo script that installs both ACCELA and SLSsteam
# Supports both local and curl | bash execution

GITHUB_USER="ciscosweater"
GITHUB_REPO="enter-the-wired"

# Detect if running via curl | bash (BASH_SOURCE empty or BASH_SOURCE[0] == "-")
RUNNING_VIA_PIPE=false
if [ -z "${BASH_SOURCE:-}" ] || [ ${#BASH_SOURCE[@]} -eq 0 ] || [[ "${BASH_SOURCE[0]:-}" == "-" ]]; then
    RUNNING_VIA_PIPE=true
fi

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

if [ "$RUNNING_VIA_PIPE" = true ]; then
    # Running via curl | bash - need to fetch scripts from GitHub
    echo -e "${GREEN}Detected pipe execution, fetching scripts from GitHub...${NC}"

    SCRIPT_DIR=$(mktemp -d)
    trap "rm -rf $SCRIPT_DIR" EXIT

    # Fetch accela and slssteam scripts
    curl -fsSL -o "$SCRIPT_DIR/accela" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/accela"
    curl -fsSL -o "$SCRIPT_DIR/slssteam" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/slssteam"

    chmod +x "$SCRIPT_DIR/accela" "$SCRIPT_DIR/slssteam"
else
    # Local execution - source from same directory
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    if [ ! -f "$SCRIPT_DIR/accela" ]; then
        echo "Error: accela not found in $SCRIPT_DIR"
        exit 1
    fi

    if [ ! -f "$SCRIPT_DIR/slssteam" ]; then
        echo "Error: slssteam not found in $SCRIPT_DIR"
        exit 1
    fi
fi

# Source the scripts to load their functions
source "$SCRIPT_DIR/accela"
source "$SCRIPT_DIR/slssteam"

echo -e "${GREEN}=============================================="
echo "  ENTER THE WIRED - Combo Installer"
echo "==============================================${NC}"
echo ""

# is_steam_deck() and get_sls_install_dir() are already sourced from slssteam

echo "Installing ACCELA..."
echo "----------------------------------------------"
install_accela

echo ""
echo "Installing SLSsteam..."
echo "----------------------------------------------"
install_slssteam

echo ""
echo "=============================================="
echo -e "${GREEN}  ALL INSTALLATIONS COMPLETED!${NC}"
echo "=============================================="
echo ""
echo "  ACCELA:    Installed at ~/.local/share/ACCELA"
echo "  SLSsteam:  Installed at $(get_sls_install_dir)"
echo "  Scripts:   Saved at ~/enter-the-wired"
echo ""

# Steam Deck specific message
if is_steam_deck; then
    echo -e "${YELLOW}  Steam Deck detected!${NC}"
    echo ""
    echo "  - SLSsteam patched in steam-jupiter for Gaming Mode"
    echo "  - Use Game Mode to launch ACCELA"
    echo "  - SLSsteam SafeMode is enabled for stability"
    echo "  - WARNING: Steam updates will reset the patch!"
    echo "  - Re-run this script after Steam updates"
else
    echo "  Launch ACCELA from your applications menu."
fi

# Bazzite specific message
if [ -f /etc/os-release ]; then
    source /etc/os-release
    if [[ "$ID" == "bazzite" ]]; then
        echo ""
        echo -e "${YELLOW}  Bazzite detected!${NC}"
        echo ""
        echo "  - ACCELA should appear in your app launcher"
        echo "  - For desktop mode, use the Applications menu"
        echo "  - Steam Deck plugins (Decky Loader) are pre-installed"
    fi
fi

echo ""
echo "  To play with SLSsteam, just restart Steam."
echo ""

# Download scripts to ~/enter-the-wired for future use
echo "Saving scripts to ~/enter-the-wired..."
echo "----------------------------------------------"

ENTER_THE_WIRED_DIR="$HOME/enter-the-wired"
mkdir -p "$ENTER_THE_WIRED_DIR"

# Download each script from GitHub
curl -fsSL -o "$ENTER_THE_WIRED_DIR/accela" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/accela"
curl -fsSL -o "$ENTER_THE_WIRED_DIR/cyberia" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/cyberia"
curl -fsSL -o "$ENTER_THE_WIRED_DIR/slssteam" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/slssteam"
curl -fsSL -o "$ENTER_THE_WIRED_DIR/uninstall" "https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/main/uninstall"

# Set execute permissions
chmod +x "$ENTER_THE_WIRED_DIR/accela" \
         "$ENTER_THE_WIRED_DIR/cyberia" \
         "$ENTER_THE_WIRED_DIR/slssteam" \
         "$ENTER_THE_WIRED_DIR/uninstall"

echo -e "${GREEN}Scripts saved to $ENTER_THE_WIRED_DIR${NC}"
echo ""
echo "=============================================="
echo -e "${YELLOW}  WHAT WAS INSTALLED${NC}"
echo "=============================================="
echo ""
echo "  ACCELA    - Installed at ~/.local/share/ACCELA"
echo "  SLSsteam  - Patched Steam for Linux Runtime"
echo ""
echo "=============================================="
echo -e "${YELLOW}  LOCAL SCRIPTS AVAILABLE${NC}"
echo "=============================================="
echo ""
echo "  ~/enter-the-wired/accela      - Install/upgrade ACCELA"
echo "  ~/enter-the-wired/cyberia     - Install Millennium + Steam integration"
echo "  ~/enter-the-wired/slssteam    - Install Steam Linux Runtime"
echo "  ~/enter-the-wired/uninstall   - Remove all installations"
echo ""
echo -e "${YELLOW}About Cyberia:${NC}"
echo "  cyberia installs the Millennium framework and the Cyberia plugin,"
echo "  which integrates ACCELA directly into the Steam client."
echo ""
echo "Protocol complete. Welcome to the Wired."
