#!/bin/bash
set -euo pipefail

# Colors (disabled if not interactive terminal)
if [ -t 1 ] && [ -t 0 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    GREEN=''
    RED=''
    YELLOW=''
    NC=''
fi

# Function to find Steam executable (handles native, Flatpak, custom paths)
find_steam_executable() {
    # 1. Use standard Steam path
    if [ -f "/usr/bin/steam" ]; then
        echo "/usr/bin/steam"
        return 0
    fi

    # 2. Check if Flatpak Steam is available
    if command -v flatpak &>/dev/null; then
        if flatpak info com.valvesoftware.Steam &>/dev/null 2>&1; then
            echo "flatpak run com.valvesoftware.Steam"
            return 0
        fi
    fi

    # 3. Check PATH for steam command (fallback)
    if command -v steam &>/dev/null; then
        echo "$(command -v steam)"
        return 0
    fi

    # 4. Check alternative paths
    for path in /usr/local/bin/steam "$HOME/.local/bin/steam"; do
        if [ -f "$path" ] && [ -x "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Function to find Steam directory
find_steam_directory() {
    # Common Steam installation paths (in order of preference)
    local steam_paths=(
        "$HOME/.steam/steam"                    # Modern Steam
        "$HOME/.local/share/Steam"              # Traditional location
        "$FLATPAK_STEAM_DIR"                    # Flatpak Steam
        "/opt/steam/steam"                      # Custom /opt
        "/usr/local/steam"                      # Custom /usr/local
    )

    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/steam.sh" ]; then
            echo "$path"
            return 0
        fi
    done

    # Fallback: check for any existing directory
    for path in "${steam_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# This script uninstalls ACCELA and SLSsteam from the user's home directory, providing a clear restart for updates and fixes.

# Check if running on Bazzite
is_bazzite() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        [[ "$ID" == "bazzite" ]] && return 0
    fi
    return 1
}

# --- Cleanup LD_AUDIT patches and wrappers ---
cleanup_ld_audit() {
    echo "Cleaning up existing LD_AUDIT patches..."

    # Clean steam.sh (all possible locations)
    for steam_sh in \
        "$HOME/.steam/steam/steam.sh" \
        "$HOME/.local/share/Steam/steam.sh" \
        "/var/home/$USER/.steam/steam/steam.sh" \
        "/var/home/$USER/.local/share/Steam/steam.sh" \
        "/usr/share/steam/steam.sh"; do
        if [ -f "$steam_sh" ]; then
            if grep -q "LD_AUDIT.*SLSsteam" "$steam_sh" 2>/dev/null; then
                sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_sh"
                echo "  Cleaned: $steam_sh"
            fi
        fi
    done

    # Clean steam-jupiter (Steam Deck)
    local steam_jupiter="/usr/bin/steam-jupiter"
    if [ -f "$steam_jupiter" ]; then
        if grep -q "LD_AUDIT.*SLSsteam" "$steam_jupiter" 2>/dev/null; then
            sudo sed -i '/export LD_AUDIT.*SLSsteam/d' "$steam_jupiter"
            echo "  Cleaned: $steam_jupiter"
        fi
    fi

    # Remove wrappers
    for wrapper in "/usr/local/bin/steam" "/usr/local/bin/bazzite-steam"; do
        if [ -f "$wrapper" ]; then
            sudo rm -f "$wrapper"
            echo "  Removed: $wrapper"
        fi
    done

    # Remove backups
    if [ -f "/usr/bin/steam-jupiter.bak" ]; then
        sudo rm -f "/usr/bin/steam-jupiter.bak"
        echo "  Removed backup: /usr/bin/steam-jupiter.bak"
    fi

    echo "Cleanup complete!"
}

# --- Cleanup SLSsteam configuration and desktop files ---
cleanup_slssteam() {
    echo "Cleaning up SLSsteam configuration..."

    local desktop_shortcut="$HOME/.local/share/applications/steam.desktop"
    local autostart_file="$HOME/.config/autostart/steam.desktop"

    # Remove desktop shortcut override (system shortcut will be used again)
    if [[ -f "$desktop_shortcut" ]]; then
        rm -f "$desktop_shortcut"
        echo "  Removed desktop shortcut override."
    fi

    # Restore autostart to use correct Steam executable
    if [[ -f "$autostart_file" ]]; then
        if is_bazzite; then
            # On Bazzite, use bazzite-steam wrapper
            sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=bazzite-steam|g' "$autostart_file"
            echo "  Restored autostart to use bazzite-steam."
        else
            # On other systems, use system steam
            sed -i 's|Exec=[^ ]*steam[^ ]*|Exec=/usr/bin/steam|g' "$autostart_file"
            echo "  Restored autostart to use /usr/bin/steam."
        fi
    fi
}

# Find steam.sh location for debugging
find_steam_sh() {
    for steam_sh in \
        "$HOME/.steam/steam/steam.sh" \
        "$HOME/.local/share/Steam/steam.sh" \
        "/var/home/$USER/.steam/steam/steam.sh" \
        "/var/home/$USER/.local/share/Steam/steam.sh" \
        "/usr/share/steam/steam.sh"; do
        if [ -f "$steam_sh" ]; then
            echo "$steam_sh"
            return 0
        fi
    done
    return 1
}

echo -e "${GREEN}Starting uninstallation...${NC}"
echo ""

# Debug: show steam.sh location
steam_sh_location=$(find_steam_sh 2>/dev/null || true)
if [ -n "$steam_sh_location" ]; then
    echo "Found steam.sh at: $steam_sh_location"
    if grep -q "LD_AUDIT" "$steam_sh_location" 2>/dev/null; then
        echo "  steam.sh contains LD_AUDIT entries:"
        grep "LD_AUDIT" "$steam_sh_location" | sed 's/^/    /'
    fi
else
    echo "Warning: steam.sh not found in any standard location"
fi
echo ""

# Cleanup LD_AUDIT patches and wrappers first
cleanup_ld_audit
echo ""

# Cleanup SLSsteam configuration and desktop files
cleanup_slssteam
echo ""

# Remove steam.cfg (created by SLSsteam to block updates)
steam_cfg_dir=$(find_steam_directory 2>/dev/null || true)
if [[ -n "$steam_cfg_dir" ]] && [[ -f "$steam_cfg_dir/steam.cfg" ]]; then
    rm -f "$steam_cfg_dir/steam.cfg"
    echo "Removed steam.cfg"
fi

# Remove ACCELA
ACCELA_DIR="$HOME/.local/share/ACCELA"
if [ -d "$ACCELA_DIR" ]; then
	rm -rf "$ACCELA_DIR"
	if [ ! -d "$ACCELA_DIR" ]; then
		echo "ACCELA removed successfully."
	else
		echo "Error: Failed to remove ACCELA." >&2
	fi
else
	echo "ACCELA directory not found. Skipping..."
fi

ACCELA_DESKTOP="$HOME/.local/share/applications/ACCELA.desktop"
if [ -f "$ACCELA_DESKTOP" ]; then
	rm -f "$ACCELA_DESKTOP"
	if [ ! -f "$ACCELA_DESKTOP" ]; then
		echo "ACCELA desktop shortcut removed."
	else
		echo "Error: Failed to remove ACCELA desktop shortcut." >&2
	fi
else
	echo "ACCELA desktop shortcut not found. Skipping..."
fi

# Remove SLSsteam (Share and Config)
SLS_SHARE="$HOME/.local/share/SLSsteam"
SLS_CONFIG="$HOME/.config/SLSsteam"
FLATPAK_SLS_SHARE="$HOME/.var/app/com.valvesoftware.Steam/.local/share/SLSsteam"
FLATPAK_SLS_CONFIG="$HOME/.var/app/com.valvesoftware.Steam/.config/SLSsteam"
FOUND_SLS=0

for dir in "$SLS_SHARE" "$SLS_CONFIG" "$FLATPAK_SLS_SHARE" "$FLATPAK_SLS_CONFIG"; do
	if [ -d "$dir" ]; then
		rm -rf "$dir"
		if [ ! -d "$dir" ]; then
			echo "Removed: $dir"
			FOUND_SLS=1
		else
			echo "Error: Failed to remove $dir" >&2
		fi
	fi
done

if [ $FOUND_SLS -eq 0 ]; then
	echo "No SLSsteam directories found. Skipping..."
fi

echo ""

# Final verification: check if steam.sh still has LD_AUDIT
steam_sh_location=$(find_steam_sh 2>/dev/null || true)
if [ -n "$steam_sh_location" ] && grep -q "LD_AUDIT.*SLSsteam" "$steam_sh_location" 2>/dev/null; then
    echo -e "${YELLOW}Warning: steam.sh still contains LD_AUDIT entries!${NC}"
    echo "  File: $steam_sh_location"
    echo "  Please manually edit this file and remove the LD_AUDIT line."
    echo "  Or run: sed -i '/export LD_AUDIT.*SLSsteam/d' $steam_sh_location"
else
    echo "Verification: steam.sh is clean (no LD_AUDIT entries found)"
fi

echo ""
echo -e "${GREEN}Uninstallation completed. Reboot recommended.${NC}"
